example_emr_eks:
  dag_id: example_emr_eks
  params: {}
  default_args:
    start_date: '2026-01-01'
  schedule: '@once'
  tasks:
    create_bucket:
      operator: airflow.providers.amazon.aws.operators.s3.S3CreateBucketOperator
      aws_conn_id: aws_default
      bucket_name: test-bucket
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_bucket
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: []
    upload_s3_file:
      operator: airflow.providers.amazon.aws.operators.s3.S3CreateObjectOperator
      aws_conn_id: aws_default
      data: |2

        k = 1
        s = 0

        for i in range(1000000):
            if i % 2 == 0:
                s += 4/k
            else:
                s -= 4/k

            k += 2

        print(s)
      encrypt: false
      outlets: []
      params: {}
      priority_weight: 1
      replace: false
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      s3_bucket: test-bucket
      s3_key: pi.py
      task_id: upload_s3_file
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [create_bucket]
    create_cluster_and_nodegroup:
      operator: airflow.providers.amazon.aws.operators.eks.EksCreateClusterOperator
      aws_conn_id: aws_default
      cluster_name: test-cluster
      cluster_role_arn: test-role-arn
      compute: nodegroup
      create_cluster_kwargs: {}
      create_fargate_profile_kwargs: {}
      create_nodegroup_kwargs:
        launchTemplate:
          name: test-launch-template
      deferrable: false
      fargate_profile_name: profile
      fargate_selectors: [{namespace: default}]
      nodegroup_name: test-nodegroup
      nodegroup_role_arn: test-role-arn
      outlets: []
      params: {}
      priority_weight: 1
      resources_vpc_config:
        subnetIds: [subnet-12345ab, subnet-67890cd]
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_cluster_and_nodegroup
      trigger_rule: all_success
      wait_for_completion: false
      wait_for_downstream: false
      waiter_delay: 30
      waiter_max_attempts: 40
      dependencies: [create_launch_template]
    await_create_nodegroup:
      operator: airflow.providers.amazon.aws.sensors.eks.EksNodegroupStateSensor
      aws_conn_id: aws_default
      cluster_name: test-cluster
      mode: poke
      nodegroup_name: test-nodegroup
      outlets: []
      params: {}
      poke_interval: 10
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      target_state: ACTIVE
      task_id: await_create_nodegroup
      timeout: 604800.0
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [create_cluster_and_nodegroup]
    create_emr_eks_cluster:
      operator: airflow.providers.amazon.aws.operators.emr.EmrEksCreateClusterOperator
      aws_conn_id: aws_default
      eks_cluster_name: test-cluster
      eks_namespace: default
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_emr_eks_cluster
      trigger_rule: all_success
      virtual_cluster_id: ''
      virtual_cluster_name: test-virtual-cluster
      wait_for_downstream: false
      dependencies: [update_trust_policy_execution_role]
    start_job:
      operator: airflow.providers.amazon.aws.operators.emr.EmrContainerOperator
      aws_conn_id: aws_default
      client_request_token: f0abb43b-7350-420b-8585-b1f8fb1f8a73
      configuration_overrides:
        monitoringConfiguration:
          cloudWatchMonitoringConfiguration:
            logGroupName: /emr-eks-jobs
            logStreamNamePrefix: airflow
      deferrable: false
      execution_role_arn: test-job-role-arn
      job_driver:
        sparkSubmitJobDriver:
          entryPoint: s3://test-bucket/pi.py
          sparkSubmitParameters: --conf spark.executors.instances=2 --conf spark.executors.memory=2G
            --conf spark.executor.cores=2 --conf spark.driver.cores=1
      job_retry_max_attempts: 5
      name: pi.py
      outlets: []
      params: {}
      poll_interval: 30
      priority_weight: 1
      release_label: emr-7.0.0-latest
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: start_job
      trigger_rule: all_success
      virtual_cluster_id: '{{ task_instance.xcom_pull(task_ids=''create_emr_eks_cluster'',
        key=''return_value'') }}'
      wait_for_completion: false
      wait_for_downstream: false
      dependencies: [create_emr_eks_cluster]
    job_waiter:
      operator: airflow.providers.amazon.aws.sensors.emr.EmrContainerSensor
      aws_conn_id: aws_default
      deferrable: false
      job_id: '{{ task_instance.xcom_pull(task_ids=''start_job'', key=''return_value'')
        }}'
      mode: poke
      outlets: []
      params: {}
      poke_interval: 60.0
      poll_interval: 10
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: job_waiter
      timeout: 604800.0
      trigger_rule: all_success
      virtual_cluster_id: '{{ task_instance.xcom_pull(task_ids=''create_emr_eks_cluster'',
        key=''return_value'') }}'
      wait_for_downstream: false
      dependencies: [start_job]
    delete_eks_cluster:
      operator: airflow.providers.amazon.aws.operators.eks.EksDeleteClusterOperator
      aws_conn_id: aws_default
      cluster_name: test-cluster
      deferrable: false
      force_delete_compute: true
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_eks_cluster
      trigger_rule: all_done
      wait_for_completion: false
      wait_for_downstream: false
      waiter_delay: 30
      waiter_max_attempts: 40
      dependencies: [delete_virtual_cluster]
    await_delete_eks_cluster:
      operator: airflow.providers.amazon.aws.sensors.eks.EksClusterStateSensor
      aws_conn_id: aws_default
      cluster_name: test-cluster
      mode: poke
      outlets: []
      params: {}
      poke_interval: 10
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      target_state: NONEXISTENT
      task_id: await_delete_eks_cluster
      timeout: 604800.0
      trigger_rule: all_done
      wait_for_downstream: false
      dependencies: [delete_eks_cluster]
    delete_bucket:
      operator: airflow.providers.amazon.aws.operators.s3.S3DeleteBucketOperator
      aws_conn_id: aws_default
      bucket_name: test-bucket
      force_delete: true
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_bucket
      trigger_rule: all_done
      wait_for_downstream: false
      dependencies: [delete_launch_template]
    create_launch_template:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_emr_eks.create_launch_template
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_launch_template
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [upload_s3_file]
      decorator: airflow.decorators.task
      template_name: test-launch-template
    run_eksctl_commands:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_emr_eks.run_eksctl_commands
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: run_eksctl_commands
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [await_create_nodegroup]
      decorator: airflow.decorators.task
      cluster_name: test-cluster
      ns: default
    update_trust_policy_execution_role:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_emr_eks.update_trust_policy_execution_role
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: update_trust_policy_execution_role
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [run_eksctl_commands]
      decorator: airflow.decorators.task
      cluster_name: test-cluster
      cluster_namespace: default
      role_name: test-job-role-name
    delete_iam_oidc_identity_provider:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_emr_eks.delete_iam_oidc_identity_provider
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_iam_oidc_identity_provider
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [job_waiter]
      decorator: airflow.decorators.task
      cluster_name: test-cluster
    delete_virtual_cluster:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_emr_eks.delete_virtual_cluster
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_virtual_cluster
      trigger_rule: all_done
      wait_for_downstream: false
      dependencies: [delete_iam_oidc_identity_provider]
      decorator: airflow.decorators.task
      virtual_cluster_id: +create_emr_eks_cluster
    delete_launch_template:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_emr_eks.delete_launch_template
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_launch_template
      trigger_rule: all_done
      wait_for_downstream: false
      dependencies: [await_delete_eks_cluster]
      decorator: airflow.decorators.task
      template_name: test-launch-template
