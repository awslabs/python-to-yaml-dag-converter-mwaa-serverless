example_athena:
  dag_id: example_athena
  params: {}
  default_args:
    start_date: '2026-01-01'
  schedule: '@once'
  tasks:
    create_s3_bucket:
      operator: airflow.providers.amazon.aws.operators.s3.S3CreateBucketOperator
      aws_conn_id: aws_default
      bucket_name: test-athena-bucket
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_s3_bucket
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: []
    upload_sample_data:
      operator: airflow.providers.amazon.aws.operators.s3.S3CreateObjectOperator
      aws_conn_id: aws_default
      data: "\"Alice\",20\n    \"Bob\",25\n    \"Charlie\",30\n    "
      encrypt: false
      outlets: []
      params: {}
      priority_weight: 1
      replace: true
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      s3_bucket: test-athena-bucket
      s3_key: test_test_table/airflow_sample.csv
      task_id: upload_sample_data
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [await_bucket]
    create_database:
      operator: airflow.providers.amazon.aws.operators.athena.AthenaOperator
      aws_conn_id: aws_default
      catalog: AwsDataCatalog
      database: test_default
      deferrable: false
      log_query: true
      max_polling_attempts: 999999
      outlets: []
      output_location: s3://test-athena-bucket/
      params: {}
      priority_weight: 1
      query: CREATE DATABASE IF NOT EXISTS test_default
      query_execution_context: {}
      result_configuration: {}
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      sleep_time: 1
      task_id: create_database
      trigger_rule: all_success
      wait_for_downstream: false
      workgroup: primary
      dependencies: [upload_sample_data]
    create_table:
      operator: airflow.providers.amazon.aws.operators.athena.AthenaOperator
      aws_conn_id: aws_default
      catalog: AwsDataCatalog
      database: test_default
      deferrable: false
      log_query: true
      max_polling_attempts: 999999
      outlets: []
      output_location: s3://test-athena-bucket/
      params: {}
      priority_weight: 1
      query: "CREATE EXTERNAL TABLE IF NOT EXISTS test_default.test_test_table\n \
        \       ( `name` string, `age` int )\n        ROW FORMAT SERDE \"org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\"\
        \n        WITH SERDEPROPERTIES ( \"serialization.format\" = \",\", \"field.delim\"\
        \ = \",\" )\n        LOCATION \"s3://test-athena-bucket//test_test_table\"\
        \n        TBLPROPERTIES (\"has_encrypted_data\"=\"false\")\n        "
      query_execution_context: {}
      result_configuration: {}
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      sleep_time: 1
      task_id: create_table
      trigger_rule: all_success
      wait_for_downstream: false
      workgroup: primary
      dependencies: [create_database]
    read_table:
      operator: airflow.providers.amazon.aws.operators.athena.AthenaOperator
      aws_conn_id: aws_default
      catalog: AwsDataCatalog
      database: test_default
      deferrable: false
      log_query: true
      max_polling_attempts: 999999
      outlets: []
      output_location: s3://test-athena-bucket/
      params: {}
      priority_weight: 1
      query: SELECT * from test_default.test_test_table
      query_execution_context: {}
      result_configuration: {}
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      sleep_time: 1
      task_id: read_table
      trigger_rule: all_success
      wait_for_downstream: false
      workgroup: primary
      dependencies: [create_table]
    await_query:
      operator: airflow.providers.amazon.aws.sensors.athena.AthenaSensor
      aws_conn_id: aws_default
      mode: poke
      outlets: []
      params: {}
      poke_interval: 60.0
      priority_weight: 1
      query_execution_id: '{{ task_instance.xcom_pull(task_ids=''read_table'', key=''return_value'')
        }}'
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      sleep_time: 10
      task_id: await_query
      timeout: 604800.0
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [read_table]
    drop_table:
      operator: airflow.providers.amazon.aws.operators.athena.AthenaOperator
      aws_conn_id: aws_default
      catalog: AwsDataCatalog
      database: test_default
      deferrable: false
      log_query: true
      max_polling_attempts: 999999
      outlets: []
      output_location: s3://test-athena-bucket/
      params: {}
      priority_weight: 1
      query: DROP TABLE IF EXISTS test_default.test_test_table
      query_execution_context: {}
      result_configuration: {}
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      sleep_time: 1
      task_id: drop_table
      trigger_rule: all_done
      wait_for_downstream: false
      workgroup: primary
      dependencies: [read_results_from_s3]
    drop_database:
      operator: airflow.providers.amazon.aws.operators.athena.AthenaOperator
      aws_conn_id: aws_default
      catalog: AwsDataCatalog
      database: test_default
      deferrable: false
      log_query: true
      max_polling_attempts: 999999
      outlets: []
      output_location: s3://test-athena-bucket/
      params: {}
      priority_weight: 1
      query: DROP DATABASE IF EXISTS test_default
      query_execution_context: {}
      result_configuration: {}
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      sleep_time: 1
      task_id: drop_database
      trigger_rule: all_done
      wait_for_downstream: false
      workgroup: primary
      dependencies: [drop_table]
    delete_s3_bucket:
      operator: airflow.providers.amazon.aws.operators.s3.S3DeleteBucketOperator
      aws_conn_id: aws_default
      bucket_name: test-athena-bucket
      force_delete: true
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_s3_bucket
      trigger_rule: all_done
      wait_for_downstream: false
      dependencies: [drop_database]
    await_bucket:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_athena.await_bucket
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: await_bucket
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [create_s3_bucket]
      decorator: airflow.decorators.task
      bucket_name: test-athena-bucket
    read_results_from_s3:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_athena.read_results_from_s3
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: read_results_from_s3
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [await_query, read_table]
      decorator: airflow.decorators.task
      bucket_name: test-athena-bucket
      query_execution_id: +read_table
