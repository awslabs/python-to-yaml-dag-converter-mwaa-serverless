example_rds_export:
  dag_id: example_rds_export
  params: {}
  default_args:
    start_date: '2026-01-01'
  schedule: '@once'
  tasks:
    create_bucket:
      operator: airflow.providers.amazon.aws.operators.s3.S3CreateBucketOperator
      aws_conn_id: aws_default
      bucket_name: test-bucket
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_bucket
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: []
    create_db_instance:
      operator: airflow.providers.amazon.aws.operators.rds.RdsCreateDbInstanceOperator
      aws_conn_id: aws_default
      db_instance_class: db.t4g.micro
      db_instance_identifier: test-instance
      deferrable: false
      engine: postgres
      outlets: []
      params: {}
      priority_weight: 1
      rds_kwargs:
        MasterUsername: rds_username
        MasterUserPassword: rds_password
        AllocatedStorage: 20
        DBName: test_db
        PubliclyAccessible: false
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_db_instance
      trigger_rule: all_success
      wait_for_completion: true
      wait_for_downstream: false
      waiter_delay: 30
      waiter_max_attempts: 60
      dependencies: [create_bucket]
    create_snapshot:
      operator: airflow.providers.amazon.aws.operators.rds.RdsCreateDbSnapshotOperator
      aws_conn_id: aws_default
      db_identifier: test-instance
      db_snapshot_identifier: test-snapshot
      db_type: instance
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: create_snapshot
      trigger_rule: all_success
      wait_for_completion: true
      wait_for_downstream: false
      dependencies: [create_db_instance]
    snapshot_sensor:
      operator: airflow.providers.amazon.aws.sensors.rds.RdsSnapshotExistenceSensor
      aws_conn_id: aws_default
      db_snapshot_identifier: test-snapshot
      db_type: instance
      hook_params: {}
      mode: poke
      outlets: []
      params: {}
      poke_interval: 60.0
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      target_statuses: [available]
      task_id: snapshot_sensor
      timeout: 604800.0
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [create_snapshot]
    get_snapshot_arn:
      outlets: []
      params: {}
      priority_weight: 1
      python_callable: airflow_rds_export.get_snapshot_arn
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: get_snapshot_arn
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [snapshot_sensor]
      decorator: airflow.decorators.task
      snapshot_name: test-snapshot
    start_export:
      operator: airflow.providers.amazon.aws.operators.rds.RdsStartExportTaskOperator
      aws_conn_id: aws_default
      export_only: []
      export_task_identifier: test-export-task
      iam_role_arn: test-role-arn
      kms_key_id: test-kms-key-id
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      s3_bucket_name: test-bucket
      s3_prefix: rds-test
      source_arn: '{{ task_instance.xcom_pull(task_ids=''get_snapshot_arn'', key=''return_value'')
        }}'
      task_id: start_export
      trigger_rule: all_success
      wait_for_completion: false
      wait_for_downstream: false
      waiter_interval: 30
      waiter_max_attempts: 40
      dependencies: [get_snapshot_arn]
    cancel_export:
      operator: airflow.providers.amazon.aws.operators.rds.RdsCancelExportTaskOperator
      aws_conn_id: aws_default
      check_interval: 10
      export_task_identifier: test-export-task
      max_attempts: 120
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: cancel_export
      trigger_rule: all_success
      wait_for_completion: true
      wait_for_downstream: false
      dependencies: [start_export]
    export_sensor:
      operator: airflow.providers.amazon.aws.sensors.rds.RdsExportTaskExistenceSensor
      aws_conn_id: aws_default
      error_statuses: [failed]
      export_task_identifier: test-export-task
      hook_params: {}
      mode: poke
      outlets: []
      params: {}
      poke_interval: 60.0
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      target_statuses: [canceled]
      task_id: export_sensor
      timeout: 604800.0
      trigger_rule: all_success
      wait_for_downstream: false
      dependencies: [cancel_export]
    delete_snapshot:
      operator: airflow.providers.amazon.aws.operators.rds.RdsDeleteDbSnapshotOperator
      aws_conn_id: aws_default
      db_snapshot_identifier: test-snapshot
      db_type: instance
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_snapshot
      trigger_rule: all_done
      wait_for_completion: true
      wait_for_downstream: false
      dependencies: [export_sensor]
    delete_bucket:
      operator: airflow.providers.amazon.aws.operators.s3.S3DeleteBucketOperator
      aws_conn_id: aws_default
      bucket_name: test-bucket
      force_delete: true
      outlets: []
      params: {}
      priority_weight: 1
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_bucket
      trigger_rule: all_done
      wait_for_downstream: false
      dependencies: [delete_snapshot]
    delete_db_instance:
      operator: airflow.providers.amazon.aws.operators.rds.RdsDeleteDbInstanceOperator
      aws_conn_id: aws_default
      db_instance_identifier: test-instance
      deferrable: false
      outlets: []
      params: {}
      priority_weight: 1
      rds_kwargs:
        SkipFinalSnapshot: true
      retries: 0
      retry_delay: 300.0
      retry_exponential_backoff: false
      task_id: delete_db_instance
      trigger_rule: all_done
      wait_for_completion: true
      wait_for_downstream: false
      waiter_delay: 30
      waiter_max_attempts: 60
      dependencies: [delete_bucket]
